// Subscription on page Drnks
$(function() {
  Subscription.init();
});


var Subscription = Subscription || {};
var dataVariants = [];
Subscription = {
  init: function() {
    this.initOnSubmitStep1();
    this.initOnSubmitStep2();
    this.initOnSubmitStep3();
    this.initOnSubmitStep4();
    this.initOnSubmitStep5();
    this.initOnSubmitStep6();
    // this.initGiftNote();
    // this.initScroll();
    // this.initCloseBottomtext();
    this.initRechargeAddToCart();
    // this.dateGift();
  },


  initOnSubmitStep1: () => {
    setTimeout(function(){
      $('.js-tab-title').trigger('click');
    },10);
    
    $(document).on('click', '.js-tab-title', function() {
      var tab_id = $(this).attr('data-tab'),
          title = $(this).find('.js-subscription-title').text();

      $('.js-tab-title').removeClass('selected');
      $(this).addClass('selected');
//       $(this).parents('.subscription-step').next().removeClass('hide');
  		
  setTimeout(function(){
        $('#'+tab_id).find('a:first-child').trigger('click');
      $(this).parents('.subscription__content').find('#step-3').removeClass('hide');
},500);

      
      $('.js-next-step').addClass('hide');
      $('[data-option-dropdown]').empty();
      $('.js-product-variants').empty();
      $('.js-roast').empty();
      $('.js-tab-content').hide();
      $("#"+tab_id).show();
      $('.js-recharge-title').text(title);
      var textPay = $(this).find('.subscription-step__title').text();
      var str = 'Ongoing subscription';
      if(textPay == str) {
        $('.js-reocuccr-pay').show();
        $('.js-per-delivery').show();
      } else {
        $('.js-reocuccr-pay').hide();
        $('.js-per-delivery').hide();
      }

      $('[data-subscription-add]').attr('data-subscription-type', title);

      if ($('.subscription.gift-subscription').length == 1) {
        $('#'+tab_id+' .js-product-item[data-shipping-interval-unit-type="Weeks"][data-shipping-interval-frequency="2"]').trigger('click');
      }
    });
  },

  initOnSubmitStep2: function() {
    $(document).on('click', '.js-product-item', function() {
      var productHandle = $(this).data('handle'),
          subscriptionID = $(this).attr('data-subscription-id'),
          data_unit_type =  $(this).attr('data-shipping-interval-unit-type'),
          data_interval_frequency = $(this).attr('data-shipping-interval-frequency'),
          title = $(this).find('.js-product-title').text(),
          baseUrl = '/products/'+productHandle+'.js',
          optionValues = [],
          optionHtml = '',
          innerHtml = '',
          innerHtml2 = '',
          innerHtml3 = '',
          delivery = $(this).data('deliverie'),
          dataVariants = [];

      $('.js-product-item').removeClass('selected');
      $('.subs-desc').removeClass('selected');
      $(this).addClass('selected');

      // $('.subscription-step__label-text').text('Select options');
      // $('[data-option-dropdown]').hide();
      // $('.js-your-coffee').removeClass('selected');
      // $('.subscription-step__option').removeClass('selected');
      
      // $('.js-next-step').addClass('hide');
      $(this).parents('.subscription-step').next().removeClass('hide');
      $('.js-text-delivery').text(delivery);

      if($('.js-text-delivery').text() == "") {
        $('.js-to-per-delivery').hide();
      } else {
        $('.js-to-per-delivery').show();
      }

      $.getJSON(baseUrl, function(product) {
        var options = product.options;
        var variant = product.variants;
        options.map(function (option, i) {
          let isWeight = false;
          let isRoast = false;
          if (option.name == 'Size' || option.name == 'size') {
            isWeight = true;
          }

          if (option.name == 'Size' || option.name == 'size') {
            isRoast = true;
          }
             
          variant.map(function(option, index) {
            const value = option.options[i];
            var imgUrl = '',
                desc = '';
            
            if(index == 0) {
              imgUrl = subscription.roast_img_1;
              desc = subscription.size_250g;
            } else {
              imgUrl = subscription.roast_img_2;
              desc = subscription.size_500g;
            }
            console.log(option.name);

            if (optionValues.indexOf(value) < 0) {

              if(isWeight) {
                innerHtml += Subscription.buildListVariants(option, value);
                optionValues.push(value);
              }
              if(isRoast){
                innerHtml2 += '<a href="#step-4" class="subscription-step__item swatch-item js-scroll-step js-your-coffee" data-coffee="'+value+'" data-value="'+value+'">',
                innerHtml2 += '<div class="subscription-step__title swatch-title">'+value+'</div>';
                innerHtml2 += '<div class="subscription-step__picture">',
                innerHtml2 += '<img class="subscription-step__img" src="'+imgUrl+'" alt="'+value+'">',
                innerHtml2 += '</div>',
                innerHtml2 += '<div class="subscription-step__desc">'+desc+'</div>'
                innerHtml2 += '</a>'
                optionValues.push(value);
              }
              if(isWeight && isRoast){
                innerHtml3 += '<li class="subscription-step-dropdown__item swatch-item js-recharge-dropdown-item" data-value="'+value+'" data-id="'+option.id+'"><a href="#step-5" class="js-scroll-step subscription-step-dropdown__link"><span class="swatch-title">'+value+'</span></a></li>';
                optionValues.push(value);
              }
            }
          });
          $('.js-product-variants').html(innerHtml);
          $('.js-roast').html(innerHtml2);
          $('[data-option-dropdown]').html(innerHtml3);
        });

        dataVariants.push(variant);

        optionHtml += '<select class="hide_" id="product-selectors-'+product.id+'" name="id">';
        variant.map(function(item) {
          optionHtml += '<option value="'+item.id+'">'+item.title+'</option>';
        });
        optionHtml += '</select>';
        $('.js-select-options').html(optionHtml);

        var productID = 'product-selectors-'+product.id+'';
        new Shopify.OptionSelectors(productID, {
            product: product,
            onVariantSelected: Subscription.selectCallback
        });

        $('.swatch-item').on('click', function() {
          var optionIndex = $(this).closest('.js-option-index').attr('data-option-index');
          var optionValue = $(this).find('.swatch-title').text();
          jQuery(this)
            .closest('.subscription__content')
            .find('.single-option-selector')
            .eq(optionIndex)
            .val(optionValue)
            .trigger('change');
        });
        if (product.available) {
          Shopify.optionsMap = {};
          // Shopify.linkOptionSelectors(product);
        }
      });

      $('.js-delivered').text(title);
      $('[data-subscription-add]').attr('data-subscription-id', subscriptionID);
      $('[data-subscription-add]').attr('data-shipping-unit', data_unit_type);
      $('[data-subscription-add]').attr('data-shipping-frequency', data_interval_frequency);
   });
  },

  initOnSubmitStep3: function() {
    $(document).on('click', '.js-recharge-variant', function() {
      var variantID = $(this).data('id'),
          variantPrice = $(this).data('price'),
          dataValue = $(this).data('value');

      $('.js-recharge-variant').removeClass('selected');
      $(this).addClass('selected');
//       $(this).parents('.subscription-step').next().removeClass('hide');

      $('.js-option-title').text(dataValue);
      // $('[data-subscription-total]').text(Shopify.formatMoney(variantPrice, theme.moneyFormat));
      $('[data-subscription-add]').attr('data-variant-id', variantID);
      $(this).parents('.subscription__content').find('#step-6').removeClass('hide');
      $(this).parents('.subscription__content').find('#step-6 .subscription__action').removeClass('hide');
      $('.subscription-step__label-text').text('test');
      $('.js-recharge-label-text').text('test');
        
    })
  },

  initOnSubmitStep4: function() {
    $(document).on('click', '.js-your-coffee', function() {
      var coffee = $(this).data('coffee');

      $('.js-your-coffee').removeClass('selected');
      $(this).addClass('selected');
      $(this).parents('.subscription-step').next().removeClass('hide');

      $('.js-coffee-text').text(coffee);
    });
  },

  initOnSubmitStep5: function() {
    $(document).on('click', '.js-subscription-label', function() {
      $('.subscription-step__option').addClass('selected');
      $('.subscription-step-dropdown').slideToggle(200);
    });
    $(document).on('click', '.js-recharge-dropdown-item', function() {
      var label = $(this).attr('data-value'),
          variantID = $(this).attr('data-id'),
          text = $(this).text();

      $('.js-recharge-dropdown-item').removeClass('active');
      $(this).addClass('active');
      $(this).parents('.subscription-step').next().removeClass('hide');
      $('.subscription-step__label-text').text(text);
      $('.js-recharge-label-text').text(label);
      $('[data-subscription-add]').attr('data-variant-id', variantID);

      if ($('.subscription.gift-subscription').length == 0) {
        $('.subscription-step').removeClass('hide');
        $('.subscription__action').removeClass('hide');
      }
    });
  },

  initOnSubmitStep6: function() {
    $(document).on('click', '.js-shipment-label', function() {
      $('.subscription-step__shipment').addClass('selected');
      $('.shipment-dropdown').slideToggle(200);
    });
    $(document).on('click', '.js-shipment-dropdown-item', function() {
      var text = $(this).text();

      $('.js-shipment-dropdown-item').removeClass('active');
      $(this).addClass('active');

      $('.shipment__label-text, .gift-subscription-data, .subscription-step__list-item-date').text(text);
      $('.gift-custom').removeClass('hide');
    });
  },


  buildListVariants: function(item, value) {
    var text_size = '';
    if (value == '6 bottles') {
      text_size = subscription.size_250g;
    } else if ( value == '12 bottles') {
      text_size = subscription.size_500g;
    }
    // } else if ( value == '750g') {
    //   text_size = subscription.size_750g;
    // } else {
    //   text_size = subscription.size_1kg;
    // }

    return [
      '<a href="#step-3" class="subscription-step__item subs-desc swatch-item js-scroll-step js-recharge-variant" data-value="'+value+'" data-price="'+item.price+'" data-id="'+item.id+'">',
        '<div class="subscription-step__title swatch-title js-variant-title">',
          ''+value+'',
        '</div>',
        '<div class="subscription-step__desc">',
          '<div class="subscription-step__line">',
            '-',
          '</div>',
            text_size,
        '</div>',
      '</a>'
    ].join('');
  },

  rechargeAddToCart: function(variant_id, quantity, subscription_type) {
    if ($('.subscription.gift-subscription').length == 1) {
      var gift_to = $('.js-gift-to').text(),
          gift_from = $('.js-gift-from').text(),
          gift_note = $('.js-notes').text();

      if (!gift_note) {
        gift_note = '';
      }

      data = {
        'quantity': quantity,
        'id': variant_id,
        'properties': {
          "subscription type": subscription_type,
        }
      }
    } else {
      var first_delivery = $('.js-first-delivery').text();

      data = {
        'quantity': quantity,
        'id': variant_id,
        'properties': {
          "subscription_type": subscription_type,
        }
      }
    }

    $.ajax({
      type: 'POST',
      url: '/cart/add.js',
      data: data,
      dataType: 'json',
      beforeSend: function() {
        $('.sbtn-ubscription-text').hide();
        $('.icon-loader').show();
      },
      success: function(items) {
        $('.sbtn-ubscription-text').show();
        $('.icon-loader').hide();
        // CartDrawer.getData();
        
        // if(is_gift_subscription == 'true') {
        //   $('[data-subscription-add]').addClass('disabled');
        //   // $('.gift-disabled-text').removeClass('hide');
        // }
        // alert ("Product add success!");
        location.reload();

      },
      error: function (xhr) {
        alert("Product error not add to cart")
        $('.icon-loader').hide();
        $('.sbtn-ubscription-text').show();
        const description = $.parseJSON(xhr.responseText).description;
        $('body').addClass('open-message');
        $('.modal-message__error').text(description);
        // if(is_gift_subscription == 'false') {
        //   $('[data-subscription-add]').removeClass('disabled');
        //   $('.gift-disabled-text').addClass('hide');
        // }
          
      }
    });
  },

  initRechargeAddToCart: function() {
    $(document).on('click', '[data-subscription-add]', function() {
      if($(this).hasClass('disabled')) {
        $('.gift-disabled-text').removeClass('hide');
        location.reload();
      } else {
        var variant_id = $('.js-select-options').find('[name="id"]').val(),
            subscription_id = $(this).attr('data-subscription-id'),
            frequency = $(this).attr('data-shipping-frequency'),
            unit_type = $(this).attr('data-shipping-unit'),
            qty = parseInt($('#quantity').val()),
            notes = $('.gift-subscription-data').text(),
            // is_gift_subscription = $(this).attr('data-gift'),
            subscription_type = $(this).attr('data-subscription-type');
            
        if (!notes) {
          notes = '';
        }
        // if(is_gift_subscription == 'true') {
        //   $('[data-subscription-add]').addClass('disabled');
        //   // $('.gift-disabled-text').removeClass('hide');
        // }
        Subscription.rechargeAddToCart(variant_id, qty, subscription_type);
      }
    });
  },

 
}

